{% extends "base.html" %} {% block title %} Live Feed - Neural Nexus {% endblock
%} {% block head %} {{ super() }}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/feed.css') }}"
/>
<style>
  button[id^="setAlarmButton"] {
    background-color: blue;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    transition:
      background-color 0.3s,
      color 0.3s;
  }
  button[id^="setAlarmButton"].active {
    background-color: red;
  }
  button[id^="recordAnomalyButton"] {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    transition:
      background-color 0.3s,
      color 0.3s;
  }
  button[id^="recordAnomalyButton"].active {
    background-color: #007bff;
  }
</style>
{% endblock %} {% block content %}
<h1>Live Feed</h1>
<div class="feed-grid-container">
  {% for video_url in video_urls %}
  <div class="video-container" id="container{{ loop.index }}">
    <div class="video-wrapper">
      <video
        id="video{{ loop.index }}"
        src="{{ video_url }}"
        autoplay
        loop
        muted
        playsinline
      ></video>
      <div class="prediction-overlay" id="overlay{{ loop.index }}">
        Loading...
      </div>
    </div>
    <div class="button-container">
      {% if current_user.role == "admin" %}
      <button id="setAlarmButton{{ loop.index }}" data-toggled="false">
        Set Alarm
      </button>
      {% endif %}
      <button id="recordAnomalyButton{{ loop.index }}" data-toggled="false">
        Record Anomaly
      </button>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %} {% block scripts %}
<script>
  // Helper function to generate a random IP address
  function randomIP() {
    return Math.floor(Math.random()*256) + '.' +
           Math.floor(Math.random()*256) + '.' +
           Math.floor(Math.random()*256) + '.' +
           Math.floor(Math.random()*256);
  }

  // Helper function to get the current timestamp in "YYYY-MM-DD HH:MM:SS" format
  function getCurrentTimestamp() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
  }

  // Return a random confidence value between 0 and 0.9 (2 decimals)
  function randomConfidence() {
    return (Math.random() * 0.9).toFixed(2);
  }

  // Return a random duration (in seconds) between 5 and 60
  function randomDuration() {
    return Math.floor(Math.random() * (60 - 5 + 1)) + 5;
  }

  // Return a random location from the given list
  function randomLocation() {
    const locations = ["Lobby", "Entrance", "Reading Hall", "Balcony", "Parking Lot", "Elevator", "Staircase", "Restroom"];
    return locations[Math.floor(Math.random() * locations.length)];
  }

  const FIGHT_THRESHOLD = 0.5;

  document.addEventListener("DOMContentLoaded", function() {
    const numVideos = {{ video_urls|length }};
    for (let i = 1; i <= numVideos; i++) {
      const videoElem = document.getElementById(`video${i}`);
      const overlayElem = document.getElementById(`overlay${i}`);

      videoElem.addEventListener('loadeddata', function() {
        const canvas = document.createElement('canvas');
        canvas.width = 224;
        canvas.height = 224;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElem, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(function(blob) {
          let formData = new FormData();
          formData.append('video_frame', blob, 'frame.jpg');
          overlayElem.innerText = "Loading...";
          fetch("/api/predict", {
            method: "POST",
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            const score = data.anomaly_score;
            if (score > FIGHT_THRESHOLD) {
              overlayElem.innerText = "Fight Detected";
              overlayElem.style.backgroundColor = "rgba(255, 0, 0, 0.7)";
            } else {
              overlayElem.innerText = "No Fight";
              overlayElem.style.backgroundColor = "rgba(0, 128, 0, 0.7)";
            }
          })
          .catch(error => {
            console.error("Error in prediction:", error);
            overlayElem.innerText = "Error";
          });
        }, 'image/jpeg');
      }, { once: true });

      {% if current_user.role == "admin" %}
      const setAlarmButton = document.getElementById(`setAlarmButton${i}`);
      setAlarmButton.addEventListener('click', function() {
        const toggled = setAlarmButton.getAttribute('data-toggled') === 'true';
        if (toggled) {
          setAlarmButton.setAttribute('data-toggled', 'false');
          setAlarmButton.innerText = "Set Alarm";
          setAlarmButton.classList.remove('active');
        } else {
          setAlarmButton.setAttribute('data-toggled', 'true');
          setAlarmButton.innerText = "Alarm Set";
          setAlarmButton.classList.add('active');
        }
      });
      {% endif %}

      const recordAnomalyButton = document.getElementById(`recordAnomalyButton${i}`);
      recordAnomalyButton.addEventListener('click', function() {
        if (recordAnomalyButton.disabled) return;
        recordAnomalyButton.disabled = true;
        recordAnomalyButton.innerText = "Recording...";

        const videoSrc = videoElem.src;
        const filename = videoSrc.split('/').pop();
        const camera_id = filename.split('.')[0];

        const anomalyData = {
          ipaddress: randomIP(),
          camera_id: camera_id,
          videopath: videoSrc,
          timestamp: getCurrentTimestamp(),
          location: randomLocation(),
          anomaly_code: "AC107",
          anomaly_name: "Fight detected",
          duration: randomDuration(),
          confidence: randomConfidence(),
          status: "No action taken",
          actions_taken: ""
        };

        fetch('/history/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(anomalyData)
        })
        .then(data => {
          recordAnomalyButton.innerText = "Anomaly Recorded";
          recordAnomalyButton.classList.add('active');
        })
        .catch(error => {
          console.error("Error recording anomaly:", error);
          recordAnomalyButton.innerText = "Error Recording";
          recordAnomalyButton.disabled = false;
        });
      });
    }
  });
</script>
{% endblock %}
